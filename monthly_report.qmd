---
title: ""
bibliography: grateful-refs.bib
format: 
  closeread-html:
    backgroundcolor: white
    mainfont: serif
    fontsize: "1.8rem"
    cr-style:
      section-background-color: white  
      narrative-font-family: serif
      narrative-text-color-sidebar: "#3E3E40"  
      narrative-background-color-sidebar: white 
      narrative-background-color-overlay: white
      narrative-text-color-overlay: "#3E3E40" 
      narrative-border-radius: "10px"  
      narrative-sidebar-width: "1fr"
      narrative-overlay-max-width: "60%"  
      narrative-outer-margin: "10px"  
      narrative-font-size: "1.2rem" 
    cr-section:
      layout: "sidebar-left"
    theme: custom.scss
execute:
  echo: false
  cache: true
---

```{r notes}
#| include: false
# things to add
# numbers of obs by category
# averages by category
# map showing observations over time animation
# lollipop summer vs winter shops - maybe summarize by category
# highest velocity based off of different time periods
start_date <- (lubridate::ymd("2025-10-30"))
```

# Monthly indoorCO2map.com summary `r start_date |> lubridate::month(label = TRUE, abbr = FALSE)` `r lubridate::today()  |> lubridate::year()`

There is a well documented relationship between indoor levels of CO~2~ and the amount of ventilation in indoor environments. Buildings with high indoor levels of CO2 have poor ventilation and are therefore more likely to be vectors of airborne diseases (like COVID-19, Measles, and Flu) and to trap indoor pollutants.

Measuring CO~2~ inside is a really cheap way of measuring the air quality in indoor environments. When we breathe, we exhale  CO~2~ and it gets trapped inside the room we are in. If the building has good ventilation it will leave quickly. If it has bad ventilation, it stays in the room and builds up.

If there is bad ventilation, then smoke from cooking can build up and that's bad for you. Same thing for VOCs from perfumes, as well as gas leaks, radon, and mold spores. At high concentrations in artificial environments, they contribute to all sorts of things: cancer, Alzheimer's, Parkinson's, childhood asthma, childhood lung problems, and heart conditions.
Bad ventilation also contributes to a much higher risk of respiratory infections. If someone who is sick breathes in a badly ventilated room, the infectious aerosols will float around in the room until someone breathes them in. In a well ventilated space, they are dispersed very quickly and the risk of infection is much lower. Having an open window in a classroom (or having an air filter), for instance, reduces school absences significantly.

CO~2~ levels outside are typically around 420 parts per million (ppm), so if we measure the CO~2~ in a room and it is higher than that, you know its not ventilating much.
Anywhere from 400 - 600 ppm are considered well ventilated. Every indoor environment is going to trap some CO~2~ and that's okay. Levels between 600 ppm and 1000 ppm may need some improvement. Anything above 1000 ppm is generally considered bad and should certainly be improved in some manner.

[Indoor CO2-Map](https://indoorco2map.com) is a community science project to monitor indoor CO~2~ levels in non-residential buildings and transit systems around the world. Since April 2024 volunteers have brought CO~2~ monitors into cafes, shops, schools, trains, and all sorts of other places to monitor CO~2~ levels in them and upload them to a public database. 

The following is a monthly summary of how this project is going.

```{r libraries}
#| warning: false
#| message: false
#| include: false 
source(here::here("functions/functions.R"))

```

```{r inputs}
#| warning: false
#| message: false
#| include: false

buildings_wide_df <- autocruller::ac_get_co2("web") 
# saveRDS(buildings_wide_df, here::here("buildings_wide_df.rds"))
# buildings_wide_df <- readRDS(here::here("buildings_wide_df.rds"))

buildings_wide_df_short <-
  buildings_wide_df |>
    # sf::st_drop_geometry() |>
    filter_to_month(start_date) |>
    dplyr::mutate(type = "building")

transit_long_df <- autocruller::ac_get_co2("transit") 
# saveRDS(transit_long_df, here::here("transit_long_df.rds"))
# transit_long_df <- readRDS(here::here("transit_long_df.rds"))

```

```{r}
#| include: false

transit_long_df <- join_transit_osm(transit_long_df)

```

```{r}
transit_long_df_short <- 
transit_long_df |> 
    filter_to_month(start_date) |> 
        dplyr::mutate(type = "transit")
```


```{r}
common_building_types <- buildings_wide_df |> 
  dplyr::group_by(osmtag) |> 
  dplyr::count() |> 
  dplyr::filter(
    n > quantile(n, 0.98, na.rm = TRUE) & osmtag != ""
    )
```

```{r}
#| include: false
# list new countries
new_countries_sentence <- form_new_countries_sentence(buildings_wide_df, buildings_wide_df_short)

```

```{r geocodebuildings}
#| eval: false
#| include: false
buildings_wide_df_short_geo <- geocode_buildings_or_transit(buildings_wide_df_short)

# saveRDS(buildings_wide_df_short_geo, here::here("data/derivative/buildings_wide_df_short_geo.rds"))
```

```{r geocodetransit}
#| eval: false
#| include: false

transit_long_df_short_geo <- geocode_buildings_or_transit(transit_long_df_short)
  
# saveRDS(transit_long_df_short_geo, here::here("data/derivative/transit_long_df_short_geo.rds"))

```


```{r}
#| include: false

buildings_wide_df_short_geo <- 
  # buildings_wide_df_short_geo |> 
  readRDS(here::here("data/derivative/buildings_wide_df_short_geo.rds")) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(
    location_description = glue::glue("{city %||% county %||% province %||% state %||% town %||% municipality %||% region %||% borough %||% suburb %||% neighbourhood %||% city_district}, {country}")
      ) |> 
    sf::st_as_sf(coords = c("X", "Y"), crs = sf::st_crs(buildings_wide_df_short))

buildings_wide_df_short <- sf::st_join(
  buildings_wide_df_short,
  buildings_wide_df_short_geo,
  left = TRUE,
  largest = TRUE
) |> dplyr::ungroup()


buildings_long_df <- autocruller::ac_unnest_longer(buildings_wide_df_short)
```

:::{.cr-section}

## Buildings

```{r mostmeasured}
#| echo: false

most_measured <- 
buildings_wide_df_short |> 
  summarise_most_measured()
  
```

This month there were `r nrow(buildings_wide_df_short)` measurements of `r length(unique(buildings_wide_df_short$combined_id))` unique buildings. @cr-ccplot 

`r describe_most_measured(most_measured)` 

```{r}
buildings_wide_df_short |> plot_histogram_co2()
```

```{r countriescount}
#| warning: false
#| message: false
countries_count <- 
buildings_wide_df_short |> 
    dplyr::group_by(countryname) |> 
    dplyr::count() |> 
    tidyr::drop_na() |> 
    sf::st_drop_geometry() |> 
    dplyr::ungroup()

# not yet done. need to give transit data a country col
# countries_count_transit <- 
#     transit_long_df |> 
#     dplyr::group_by(countryname) |> 
#     dplyr::summarise(dplyr::n_distinct(uid)) |> 
#     tidyr::drop_na() |> 
#     sf::st_drop_geometry()
# then join with countries_count
countries_count <- countries_count[order(countries_count$n, decreasing = TRUE),] |> 
  tidyr::drop_na() |> 
  dplyr::filter(countryname != "")
# countries_count <- dplyr::left_join(countries_count, countries_count_transit, by = dplyr::join_by(countryname))
# countries_count |> 
#     gt() |> 
#     tab_header(title = "Top countries") |> 
#     cols_label(
#         countryname = "Country",
#         n = "Number of buildings"
#     ) |> 
#     tab_options(
#         table_body.hlines.width = 0
#         )
    
```

:::{#cr-ccplot}

```{r ccplot}
#| warning: false
#| message: false
countries_count |> 
  tidyplot(
    x = countryname,
    y = n,
    color = countryname
    ) |>  
    add_barstack_absolute() |> 
    adjust_x_axis(
    rotate_labels = TRUE
  ) |>
    sort_x_axis_labels() |> 
    add_data_labels(
      label = n, 
      color = "black",
      label_position = "above",
      fontsize = 14
      ) |> 
    adjust_size(width = NA, height = NA, unit = "cm") |> 
    adjust_font(fontsize = 14) |> 
    adjust_y_axis_title("Number of measurements") |> 
    adjust_x_axis_title("Country") |> 
    remove_legend() |> 
    adjust_padding(top = 0.3) |> 
    adjust_title("Building measurements per country") |> 
    adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

There were measurements in `r nrow(countries_count)` seperate countries. `r new_countries_sentence`  

  @cr-buildingtypes 

This graph shows the distribution of the most common building types in the month of `r start_date  |> lubridate::month(label = TRUE, abbr = FALSE)`. The dark bar in the middle of each box and whisker plot shows the median value for each category. The rest of the lines show the range of the distribution. Most of the values fall within each box. If you want more information about how to interpret this graph, watch [this video](https://youtu.be/b2C9I8HuCe4?si=73FKu7wSJr1rWwWt).

As is common, supermarkets tend to have higher CO~2~ values than other types of buildings.

```{r buildingtypes}
#| include: true
#| eval: true
#| warning: false
#| message: false
#| fig.asp: 1.2
buildings_wide_df |> 
# buildings_long_df |>  
  dplyr::filter(
    dplyr::between(
        date,
        (lubridate::ceiling_date(start_date, unit = "month") - lubridate::years(1)),
        start_date |> lubridate::ceiling_date(unit = "month")
    ),
    ppmavg >= 410
    ) |> 
  # sf::st_drop_geometry() |> 
  dplyr::mutate(
    newtag = dplyr::if_else(
      osmtag %in% common_building_types$osmtag,
      osmtag,
      "other"
    ) |> 
      stringr::str_replace_all("_", " ") |> 
      stringr::str_to_sentence(),
    # month =  paste0(lubridate::month(date, label = TRUE), " ", lubridate::year(date)) |> factor()
    month =  lubridate::floor_date(date, unit = "month") |> lubridate::date()
    ) |> 
  dplyr::group_by(month, newtag) |> 
  dplyr::tally() |> 
  tidyr::drop_na() |> 
  tidyplot(x = month, y = n, color = newtag) |> 
  add_barstack_absolute(width = 31) |> 
  adjust_x_axis(rotate_labels = TRUE) |> 
  adjust_y_axis_title("Number of observations") |> 
  adjust_x_axis_title("Date (month)") |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_colors(colors_discrete_seaside) |> 
  # adjust_font(family = "Atkinson Hyperlegible") |> 
  remove_legend_title() 
```

:::{#cr-buildingtypes}

```{r buildingtypes}
#| include: true
#| eval: true
#| warning: false
#| message: false
#| fig.asp: 1.2
buildings_long_df |> 
  dplyr::filter(
    co2readings >= 410
  ) |> 
  dplyr::mutate(
    newtag = dplyr::if_else(
      osmtag %in% common_building_types$osmtag,
      osmtag,
      "other"
    ) |> 
      stringr::str_replace_all("_", " ") |> 
      stringr::str_to_sentence()
    ) |> 
  dplyr::group_by(obs_number) |> 
  dplyr::summarise(
    ppmavg = median(ppmavg, na.rm = TRUE),
    newtag = dplyr::first(newtag)
    ) |>  
  dplyr::mutate(
    percent_rebreathed = ((ppmavg - 420)/38000) * 100
  ) |> 
  sf::st_drop_geometry() |> 
tidyplot(
    x = newtag,
    y = percent_rebreathed,
    fill = ppmavg
    ) |>  
    add_data_points_beeswarm(size = 3, alpha = 0.4) |> 
    add_boxplot(linewidth = 1.4, fill = "white", color = "grey30", show_outliers = FALSE) |> 
    # add_curve_fit(linewidth = 2,  alpha = 0.5,  se = FALSE) |> 
    # add_data_points(size = 2, alpha = 0.4) |> 
    adjust_x_axis(
    title = "Building type",
    rotate_labels = TRUE
    # breaks = seq(0, 52, by = 4)
  ) |>
  # adjust_y_axis(
  #   transform = "log2",
  #   # limits = c(420, NA)
  #   ) |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  remove_legend() |> 
  # adjust_legend_title("Building type") |> 
  adjust_y_axis_title("Percent rebreathed CO2") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

```{r highlowbuildings}
#| include: false
buildings_long_df_med <- buildings_long_df |> 
  dplyr::filter(
    co2readings >= 400
  ) |> 
    dplyr::group_by(obs_number) |> 
    dplyr::mutate(
      median_co2 = median(co2readings),
      time_n = dplyr::row_number(),
      time_range = range01(time_n),
      description_str = glue::glue("{nwrname} in {location_description}")
    ) |> 
      dplyr::ungroup()

highest_building <- buildings_long_df_med |> 
  dplyr::slice_max(order_by = median_co2)
lowest_building <- buildings_long_df_med |> 
  dplyr::slice_min(order_by = median_co2)
```

```{r highlowsentence}
#| include: false

lowest_sentence <- lowest_building |> 
  dplyr::group_by(obs_number) |> 
  dplyr::summarise(
    description_str = dplyr::first(description_str),
    median_co2 = dplyr::first(median_co2)
  ) |> 
    describe_buildings(measure = "lowest")

highest_sentence <- highest_building |> 
  dplyr::group_by(obs_number) |> 
  dplyr::summarise(
    description_str = dplyr::first(description_str),
    median_co2 = dplyr::first(median_co2)
  ) |> 
    describe_buildings(measure = "highest")

co2_threshold <- 500

buildings_under_threshold <- 
  buildings_long_df_med |> 
  dplyr::filter(median_co2 < co2_threshold) |> 
  dplyr::group_by(obs_number) |> 
  dplyr::summarise(
    name = dplyr::first(nwrname),
    co2 = dplyr::first(median_co2),
    osmtag = dplyr::first(osmtag) |> stringr::str_to_sentence(),
    location_description = dplyr::first(location_description)
  ) |> 
  dplyr::select(
    -obs_number
  )
```

Here is a graph of all the recordings that happened this month shown by the grey curves. I've highlighted the highest and lowest ones. @cr-allcurves 

`r highest_sentence` `r lowest_sentence` There were some measurements that were even lower than this, but we have removed them from this analysis. Generally outdoor CO~2~ levels don't go below 410 ppm, therefore we have removed any datapoints that are below 400 ppm. If your CO~2~ monitor consistently shows levels below 410 ppm while you are inside or outside, it is likely that your monitor needs recalibrating.

```{r}
#| warning: false
#| eval: false
co2df <- tibble::tibble(
  time = 1:length(highest_building$obs_number),
  co2 = highest_building$co2readings,
  building = highest_building$nwrname
)

ggplot(co2df, aes(x = time, y = co2, color = building)) +
  geom_smooth(color = "grey80") +
  geom_point(size = 4) +
  ylim(400, NA) + 
  xlab("Time (minutes)") +
  ylab(bquote(CO^2)) +
  theme_minimal() +
  theme(
    text = element_text(size = 16),
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 16),
    axis.line = element_line(colour = "black", size = 1, linetype = "solid"),
    legend.position="none"
    )
```

```{r}
#| warning: false
#| eval: false
co2df <- tibble::tibble(
  time = lowest_building$time,
  co2 = lowest_building$co2readings,
  building = lowest_building$nwrname
)

ggplot(co2df, aes(x = time, y = co2, color = building)) +
  geom_smooth() +
  geom_point(size = 4) +
  ylim(400, NA) + 
  xlab("Time (minutes)") +
  ylab(bquote(CO^2)) +
  theme_minimal() +
  theme(
    text = element_text(size = 16),
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 16),
    axis.line = element_line(colour = "black", size = 1, linetype = "solid"),
    legend.position="none"
    )
```

:::{#cr-allcurves}

```{r allcurves1}
#| warning: false
#| message: false
ylim_max <- max(highest_building$co2readings) + 200

buildings_box <- 
buildings_long_df_med |> 
  dplyr::group_by(obs_number) |> 
ggplot(aes(x = 1, y = co2readings)) +
  geom_boxplot(outliers = FALSE) +
  ylim(400, ylim_max) + 
  ylab(bquote(CO^2)) +
  theme_void() +
  theme(
    plot.title = element_text(size = 12),
    panel.grid = element_blank(),
    axis.text.x = element_blank(),
    legend.position="none"
    ) 
```

```{r allcurves2}
#| warning: false
#| message: false

buildings_lines <- 
buildings_long_df_med |> 
  dplyr::group_by(obs_number) |> 
  sf::st_drop_geometry() |> 
ggplot(aes(x = time_range, y = co2readings, group = obs_number)) +
  geom_smooth(
    se = FALSE,
    color = "grey80",
    linewidth = 0.5
  ) +
  geom_smooth(
    data = lowest_building,
    mapping = aes(x = time_range, y = co2readings, color = obs_number),
    se = FALSE
  ) +
  geom_point(
    data = lowest_building,
    mapping = aes(x = time_range, y = co2readings, color = obs_number),
    size = 4
  ) +
  geom_smooth(
    data = highest_building,
    mapping = aes(x = time_range, y = co2readings, color = obs_number),
    se = FALSE
  ) +
  geom_point(
    data = highest_building,
    mapping = aes(x = time_range, y = co2readings, color = co2readings),
    size = 4
    ) +
  # scale_color_viridis_c()+
  scico::scale_color_scico("hawaii", direction = -1) +
  annotate(
    "label", 
    x = .7,
    y =  mean(lowest_building$ppmavg, na.rm = TRUE) + 140,
    label = unique(lowest_building$nwrname) |> stringr::str_flatten_comma(last = ' and ')
    ) +
  annotate(
    "label", 
    x = .2,
    y =  mean(highest_building$ppmavg, na.rm = TRUE) - 140,
    label = unique(highest_building$nwrname) |> stringr::str_flatten_comma(last = ' and ')
    ) +
  ylim(400, ylim_max) + 
  labs(title = "Highest and lowest recordings this month") +
  xlab("Time (from recording start to end)") +
  ylab(bquote(CO^2)) +
  theme_minimal() +
  theme(
    text = element_text(size = 16),
    plot.title = element_text(size = 12),
    panel.grid = element_blank(),
    axis.text.x = element_text(size = 16),
    axis.line = element_line(colour = "black", linewidth = 1, linetype = "solid"),
    legend.position="none"
    ) 

    # buildings_lines

```

```{r allcurves3}
#| warning: false
#| message: false
#| fig.asp: 1.4
buildings_lines + buildings_box + plot_layout(widths = c(10, 1))
```

:::
:::

Here is a chart showing the `r nrow(buildings_under_threshold)` measurements that had a median CO~2~ value under `r co2_threshold`. Keep in mind that some of these are potentially miscalibrated sensors or erroneous recordings where the sensor was outside. However, it is important to celebrate the places that do in fact have well ventilated spaces.

```{r thresholdtable}
#| warning: false
#| message: false

# add a column showing how many times a building has been on this list
# buildings_under_threshold |> 
#   knitr::kable(
#     col.names = c("Name", "Median CO<sup>2</sup>", "Building type", "Location")
#   )
 buildings_under_threshold |> 
  dplyr::mutate(
    osmtag = stringr::str_replace_all(osmtag, "_", " ")
  ) |> 
    gt() |> 
    tab_header(title = "Measurements under 500 ppm") |> 
    cols_label(
        name = "Name",
        co2 = "CO2 ppm",
        osmtag = "Building type",
        location_description = "Location"
    ) |> 
    tab_options(
        table_body.hlines.width = 0
        )
        
```

## Trends over time

The following are charts that are updated every month, but they reflect all data collected so far from the indoorco2 monitoring project (since April 2024). Over time, we should be able to see yearly trends where CO~2~ levels are higher in the Winter when shopkeepers close their windows to keep things warm and then lower CO~2~ levels when shopkeepers open their windows in the Summer.

:::{.cr-section}

@cr-metweekall 

We can start to see trends like in this graph which shows CO~2~ against the week of the year. There are two relevant points you should know about the X axis `Week of the year (meteorological)` before moving on.

1.  Datapoints are aggregated into weeks regardless of the year they are collected in, so some weeks were measured in both 2024 and 2025 but they would both show up in the same week number.

2.  This takes account of the hemisphere in which the recording was collected. Since Winter in the Southern Hemisphere is June through August, while Winter in the Northern Hemisphere is December through February, we have adjusted the week numbers so that they line up meterologically. Essentially, a measurement collected in the Northern Hemisphere on the first of January would show up as week 1, however, a measurement collected in the Southern Hemisphere on the first of January would show up as week 27.

:::{#cr-metweekall}

```{r converthemisphere}
buildings_wide_df <- 
  buildings_wide_df |> 
  dplyr::mutate(
    meteorological_week = dplyr::if_else(
      sf::st_coordinates(geometry)[,2] < 0,
      lubridate::week(date) |> convert_hemisphere() |> factor(),
      lubridate::week(date) |> factor()
    )  
  )
```

```{r}
#| include: false
#| eval: false
buildings_wide_df |> 
  dplyr::mutate(
    year_month = paste0(lubridate::year(date), "-", lubridate::month(date))
    ) |> 
tidyplot(
    x = year_month,
    y = ppmavg
    ) |>  
    add_boxplot() |> 
    adjust_x_axis(
    title = "Date",
    rotate_labels = TRUE
  ) |>
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_y_axis_title("CO2 ppm average") |> 
  remove_legend() |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

```{r metweekall}
#| include: true
#| eval: true
#| warning: false
#| message: false

buildings_wide_df |> 
  dplyr::group_by(meteorological_week) |> 
  dplyr::summarise(
    ppmavg = median(ppmavg, na.rm = TRUE)
    ) |> 
tidyplot(
    x = meteorological_week,
    y = ppmavg
    ) |>  
    add_curve_fit(linewidth = 2,  alpha = 0.5,  se = FALSE) |> 
    add_data_points(size = 2, alpha = 0.4) |> 
    adjust_x_axis(
    title = "Week of the year (meteorological)",
    # rotate_labels = TRUE,
    breaks = seq(0, 52, by = 4)
  ) |>
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_legend_position("top") |> 
  adjust_y_axis_title("CO2 ppm median") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

@cr-metweektype

If we split the graph by the most popular building types, we can start to see some interesting trends. Supermarkets remain relatively high throughout the year with little variation while fast food, and chemists have quite a strong dip in CO~2~ levels during the Summer. This may be because most supermarkets keep their doors closed throughout the year and they tend to have larger buildings; conversely, chemists and fast food restraunts tend to be small to medium sized buildings which means that they can be very easily ventilated if they leave their front door open in the Summer. Restaurants have a very interesting trend here, the strong upward trend of the model at the end of the year is probably due to not enough measurements of restaurants yet rather that there being any meaningful conclusions. Over time we should hopefully see more stable trends show up.

:::{#cr-metweektype}

```{r metweektype}
#| include: true
#| eval: true
#| warning: false
#| message: false

buildings_wide_df |> 
  dplyr::mutate(
    newtag = dplyr::if_else(
      osmtag %in% common_building_types$osmtag,
      osmtag,
      "other"
    ) |> 
      stringr::str_replace_all("_", " ") |> 
      stringr::str_to_sentence()
    ) |> 
  dplyr::group_by(meteorological_week, newtag) |> 
  dplyr::summarise(
    ppmavg = median(ppmavg, na.rm = TRUE)
    ) |>  
tidyplot(
    x = meteorological_week,
    y = ppmavg,
    color = newtag
    ) |>  
    add_curve_fit(linewidth = 2,  alpha = 0.5,  se = FALSE) |> 
    add_data_points(size = 2, alpha = 0.4) |> 
    adjust_x_axis(
    title = "Week of the year (meteorological)",
    # rotate_labels = TRUE,
    breaks = seq(0, 52, by = 4)
  ) |>
  adjust_y_axis(
    limits = c(NA, 1200)
    ) |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_legend_title("Building type") |> 
  adjust_y_axis_title("CO2 ppm median") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

```{r measurethisyear}
#| include: false
measurements_this_year <- 
  buildings_wide_df |> 
  dplyr::filter(dplyr::between(
        date,
        lubridate::today() - lubridate::weeks(52),
        lubridate::today()
    ))|>
       nrow() 
```

Here's a histogram showing how many measurements have been recorded each week since the start of the project. Over the last 12 months there have been `r measurements_this_year` building measurements which is `r round(measurements_this_year/12)` per month or `r round(measurements_this_year/52)` per week. @cr-allhist

:::{#cr-allhist}

```{r allhist}
#| include: true
#| eval: true
#| warning: false
#| message: false
buildings_wide_df |> 
tidyplot(
    x = date
    ) |>  
    add_histogram(
      bins = ceiling((lubridate::interval(buildings_wide_df$date |> min(), buildings_wide_df$date |> max()))/lubridate::dweeks(1))
      ) |> 
    adjust_x_axis(
    title = "Date",
    breaks = scales::breaks_width("2 months"),
    labels = scales::label_date("%Y-%m"),
    rotate_labels = TRUE
  ) |>
#   adjust_y_axis(transform = "log2") |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_y_axis_title("Observations per week") |> 
  remove_legend() |> 
#   adjust_title("CO2 Averages at music venues") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::
:::

## Transit

```{r transitgeo}
#| eval: true
#| include: false
transit_long_df_short_geo <- 
  # transit_long_df_short_geo |> 
  readRDS(here::here("data/derivative/transit_long_df_short_geo.rds")) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(
    location_description = glue::glue("{city %||% county %||%  state %||% town %||% municipality %||% region %||% borough %||% suburb %||% neighbourhood %||% city_district}, {country}")
      ) |> 
     sf::st_as_sf(coords = c("X", "Y"), crs = sf::st_crs(transit_long_df_short))

transit_long_df_short <- transit_long_df_short |> 
  dplyr::mutate(osm_id_line = as.integer(osm_id_line))

# this doesn't work
# transit_long_df_short <- dplyr::left_join(
#   transit_long_df_short,
#   transit_long_df_short_geo,
#   by = dplyr::join_by(osm_id_line == place_id)
# )

transit_long_df_short <- sf::st_join(
  transit_long_df_short,
  transit_long_df_short_geo,
  left = TRUE,
  largest = TRUE
) |> dplyr::ungroup()
```



```{r mmtransit}
#| echo: false
most_measured_transit <- 
transit_long_df_short |> 
  dplyr::group_by(line) |> 
  dplyr::summarise(
    n = length(unique(uid)),
    lineName = dplyr::first(ref),
    route = dplyr::first(route),
    network = dplyr::first(network_best),
    operator = dplyr::first(operator_best),
    countryname = dplyr::first(country),
    location_description = dplyr::first(location_description),
    min_day = min(date),
    max_day = max(date),
    ppm_min = min(co2Array) |> round(),
    ppm_avg = mean(co2Array) |> round(),
    ppm_max = max(co2Array) |> round()
  ) |> 
  dplyr::slice_max(n = 1, order_by = n)
```

:::{.cr-section}

This month there were `r length(unique(transit_long_df_short$uid))` measurements of `r length(unique(transit_long_df_short$line))` unique transit lines. `r describe_most_measured_transit(most_measured_transit)` This graph shows the number of transit recordings in each transit network during the last month. Keep in mind that this graph only shows networks with more than 2 transit recordings this month (there were quite a few with one or two). Transit recordings seem very popular in Vienna and Munich at the moment. @cr-transitcount

:::{#cr-transitcount}

```{r transitcount}
#| warning: false
#| message: false
transit_count <- 
transit_long_df_short |> 
    dplyr::rowwise() |> 
    dplyr::mutate(
       location_description = stringr::str_replace_all(
        location_description,
        "United States of America",
        "USA"
       )
    #   city_country = city %||% country,
    #   line_loc = glue::glue("{network_best} ({city_country})")
    ) |> 
    dplyr::group_by(location_description) |> 
    dplyr::summarise(
      n = dplyr::n_distinct(uid)
    ) |> 
    tidyr::drop_na() |> 
    sf::st_drop_geometry() |> 
    dplyr::ungroup() |> 
    dplyr::filter(n > 2)
```

```{r transitcountbar}
#| warning: false
#| message: false
transit_count |> 
  dplyr::filter(n > 2) |> 
  tidyplot(
    x = location_description,
    y = n,
    color = location_description
    ) |>  
    add_barstack_absolute() |> 
    adjust_x_axis(
    rotate_labels = 65
  ) |>
    sort_x_axis_labels() |> 
    add_data_labels(
      label = n, 
      color = "black",
      label_position = "above",
      fontsize = 14
      ) |> 
    adjust_size(width = NA, height = NA, unit = "cm") |> 
    adjust_font(fontsize = 12) |> 
    adjust_y_axis_title("Number of measurements") |> 
    adjust_x_axis_title("Community") |> 
    remove_legend() |> 
    adjust_padding(top = 0.3) |> 
    adjust_title("Transit measurements per community") |> 
    adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

When we look at the distribution of CO~2~ measurements by the transit type this month we can see some patterns. Trains often have higher CO~2~ values than buses, subways and trams because they usually travel for longer distances between stations. This causes trains to rely more heavily on mechanical ventilation than buses, subways, and trams which open their doors at stations more frequently. @cr-transitmonthbox

:::{#cr-transitmonthbox}

```{r transitmonthbox}
#| include: true
#| eval: true
#| warning: false
#| message: false

transit_long_df_short |> 
    tidyr::drop_na(route) |> 
  dplyr::filter(
    co2Array >= 410
    # location_description %in% transit_count$location_description
  ) |> 
  dplyr::mutate(
    route = stringr::str_to_sentence(route) |> stringr::str_replace_all("_", " ")
    ) |>  
tidyplot(
    x = route,
    y = co2Array,
    fill = co2Array
    ) |>   
    add_data_points_beeswarm(size = 1, alpha = 0.15) |> 
    add_boxplot(linewidth = 1.4, fill = "white", color = "grey30", show_outliers = FALSE) |>
    # add_curve_fit(linewidth = 2,  alpha = 0.5,  se = FALSE) |> 
    # add_data_points(size = 2, alpha = 0.4) |> 
    adjust_x_axis(
    title = "Transit type",
    rotate_labels = TRUE
  ) |>
    # sort_x_axis_labels() |> 
  adjust_y_axis(
    transform = "log10",
    limits = c(420, NA)
    ) |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  remove_legend() |> 
  # adjust_legend_title("Building type") |> 
  adjust_y_axis_title("CO2 ppm") |> 
  add_title("CO2 Distribution (this month)") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

This trend can also be seen when we look at the distribution of each transit type on all the data from 2024 and 2025. @cr-transitallbox

:::{#cr-transitallbox}

```{r transitallbox}
#| include: true
#| eval: true
#| warning: false
#| message: false

transit_long_df |> 
  tidyr::drop_na(route) |> 
  dplyr::filter(
    co2Array >= 410
    # location_description %in% transit_count$location_description
  ) |> 
  dplyr::mutate(
    route = stringr::str_to_sentence(route) |> stringr::str_replace_all("_", " ")
    ) |> 
  # dplyr::group_by(route) |> 
  # dplyr::summarise(
  #   ppmavg = median(co2Array, na.rm = TRUE),
  #   location_description = dplyr::first(location_description)
  #   ) |>  
tidyplot(
    x = route,
    y = co2Array,
    fill = co2Array
    ) |>   
    # add_data_points_beeswarm(size = 1, alpha = 0.1) |> 
    add_boxplot(linewidth = 1.4, fill = "white", color = "grey30", show_outliers = FALSE) |>
    # add_curve_fit(linewidth = 2,  alpha = 0.5,  se = FALSE) |> 
    # add_data_points(size = 2, alpha = 0.4) |> 
    adjust_x_axis(
    title = "Transit type",
    rotate_labels = TRUE
  ) |>
    # sort_x_axis_labels() |> 
  # adjust_y_axis(
  #   transform = "log2",
  #   limits = c(420, NA)
  #   ) |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  remove_legend() |> 
  # adjust_legend_title("Building type") |> 
  adjust_y_axis_title("CO2 ppm") |> 
  add_title("CO2 Distribution (all data)") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::


```{r transitmetweek}
transit_long_df <- 
  transit_long_df |> 
  dplyr::mutate(
    meteorological_week = dplyr::if_else(
      sf::st_coordinates(geometry)[,2] < 0,
      lubridate::week(date) |> convert_hemisphere(),# |> factor(),
      lubridate::week(date), # |> factor()
    )
  )
```

```{r transitmetplot}
#| include: false
#| eval: false
#| warning: false
#| message: false

transit_long_df |> 
  dplyr::group_by(meteorological_week) |> 
  dplyr::summarise(
    ppmavg = median(co2Array, na.rm = TRUE)
    ) |>  
tidyplot(
    x = meteorological_week,
    y = ppmavg
    # color = route
    ) |>  
    add_curve_fit(linewidth = 2,  alpha = 0.5,  se = FALSE) |> 
    add_data_points(size = 2, alpha = 0.4) |> 
    adjust_x_axis(
    title = "Week of the year (meteorological)",
    rotate_labels = TRUE,
    breaks = seq(0, 52, by = 4)
  ) |>
  adjust_y_axis(
    limits = c(NA, 1200)
    ) |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_legend_title("Transit type") |> 
  adjust_y_axis_title("CO2 ppm median") |> 
  # reorder_x_axis_labels(seq(0, 52, by = 1)) |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

:::

That's all for this month! Check back soon for more updates.


### Some thanks

This work would not be possible without the hard work of all the contributors to [OpenStreetMap](https://www.openstreetmap.org/) and [indoorco2map](https://indoorco2map.com). If you would like to contribute to either of these projects, please visit their websites.
You can contribute to the indoorco2map by downloading the [Android app](https://play.google.com/store/apps/details?id=com.aurelwu.indoorairqualitycollector&pcampaignid=pcampaignidMKT-Other-global-all-co-prtnr-py-PartBadge-Mar2515-1) or [iOS app](https://apps.apple.com/us/app/indoorco2map-data-collector/id6504560820?itscg=30200&itsct=apps_box_badge&mttnsubad=6504560820) and connecting it to any one of the following CO~2~ sensors: Aranet4, Airvalent, AirSpot and Inkbird IAM-T1. 
I would also like to thank [Aurel WÃ¼nsch](https://github.com/AurelWu) who tirelessly works on the project as well as the other contributors to the project [ahunt](https://github.com/ahunt), [da5nsy](https://github.com/da5nsy), [paul-hammant](https://github.com/paul-hammant), and [samherniman](https://github.com/samherniman). 

Finally, many thanks go to the teams who work on the following software, which I used heavily. 
```{r}
grateful::cite_packages(output = "paragraph", out.dir = ".")
```

<!-- ## Everything -->

<!-- Combine both long datasets and then make a beeswarm comparing buildings to transit -->

```{r}
#| warning: false
#| message: false
#| eval: false
#| include: false
buildings_long_df |> 
    dplyr::group_by(obs_number) |> 
    dplyr::summarise(
        co2_median = median(co2readings, na.rm = TRUE),
        ventilation = dplyr::first(ventilation)
        ) |> 
tidyplot(
         x = ventilation, 
         y = co2_median,
         color = co2_median
         ) |> 
  # add_violin() |>
  add_data_points_beeswarm(size = 3) |> 
  adjust_y_axis(transform = "log2") |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_x_axis_title("Ventilation system on?") |> 
  adjust_y_axis_title("CO2 ppm average") |> 
  remove_legend() |> 
  # adjust_title("CO2 Averages at music venues") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

```{r}
#| include: false
#| eval: false

buildings_long_df |> 
    dplyr::group_by(obs_number) |> 
    dplyr::summarise(
        co2_median = median(co2readings, na.rm = TRUE),
        openwindows = dplyr::first(openwindows)
        ) |> 
    sf::st_drop_geometry() |> 
tidyplot(
         x = openwindows, 
         y = co2_median,
         color = co2_median
         ) |> 
  # add_violin() |>
  add_data_points_beeswarm(size = 3) |> 
  adjust_y_axis(transform = "log2") |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_x_axis_title("Windows open?") |> 
  adjust_y_axis_title("CO2 ppm average") |> 
  remove_legend() |> 
  # adjust_title("CO2 Averages at music venues") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```