---
title: ""
bibliography: grateful-refs.bib
format: 
  closeread-html:
    backgroundcolor: white
    mainfont: serif
    fontsize: "1.8rem"
    cr-style:
      section-background-color: white  
      narrative-font-family: serif
      narrative-text-color-sidebar: "#3E3E40"  
      narrative-background-color-sidebar: white 
      narrative-background-color-overlay: white
      narrative-text-color-overlay: "#3E3E40" 
      narrative-border-radius: "10px"  
      narrative-sidebar-width: "1fr"
      narrative-overlay-max-width: "60%"  
      narrative-outer-margin: "10px"  
      narrative-font-size: "1.2rem" 
    cr-section:
      layout: "sidebar-left"
    theme: custom.scss
execute:
  echo: false
  cache: true
---

```{r notes}
#| include: false
# things to add
# numbers of obs by category
# averages by category
# map showing observations over time animation
# lollipop summer vs winter shops - maybe summarize by category
# highest velocity based off of different time periods
start_date <- (lubridate::ymd("2025-10-30"))
```

# Monthly indoorCO2map.com summary `r start_date |> lubridate::month(label = TRUE, abbr = FALSE)` `r lubridate::today()  |> lubridate::year()`

There is a well documented relationship between indoor levels of CO~2~ and the amount of ventilation in indoor environments. Buildings with high indoor levels of CO2 have poor ventilation and are therefore more likely to be vectors of airborne diseases (like COVID-19, Measles, and Flu) and to trap indoor pollutants.

Measuring CO~2~ inside is a really cheap way of measuring the air quality in indoor environments. When we breathe, we exhale  CO~2~ and it gets trapped inside the room we are in. If the building has good ventilation it will leave quickly. If it has bad ventilation, it stays in the room and builds up.

If there is bad ventilation, then smoke from cooking can build up and that's bad for you. Same thing for VOCs from perfumes, as well as gas leaks, radon, and mold spores. At high concentrations in artificial environments, they contribute to all sorts of things: cancer, Alzheimer's, Parkinson's, childhood asthma, childhood lung problems, and heart conditions.
Bad ventilation also contributes to a much higher risk of respiratory infections. If someone who is sick breathes in a badly ventilated room, the infectious aerosols will float around in the room until someone breathes them in. In a well ventilated space, they are dispersed very quickly and the risk of infection is much lower. Having an open window in a classroom (or having an air filter), for instance, reduces school absences significantly.

CO~2~ levels outside are typically around 420 parts per million (ppm), so if we measure the CO~2~ in a room and it is higher than that, you know its not ventilating much.
Anywhere from 400 - 600 ppm are considered well ventilated. Every indoor environment is going to trap some CO~2~ and that's okay. Levels between 600 ppm and 1000 ppm may need some improvement. Anything above 1000 ppm is generally considered bad and should certainly be improved in some manner.

[Indoor CO2-Map](https://indoorco2map.com) is a community science project to monitor indoor CO~2~ levels in non-residential buildings and transit systems around the world. Since April 2024 volunteers have brought CO~2~ monitors into cafes, shops, schools, trains, and all sorts of other places to monitor CO~2~ levels in them and upload them to a public database. 

The following is a monthly summary of how this project is going.

```{r libraries}
#| warning: false
#| message: false
#| include: false 
source(here::here("functions/functions.R"))

```

```{r inputs}
#| warning: false
#| message: false
#| include: false

buildings_wide_df <- autocruller::ac_get_co2("web") 
# saveRDS(buildings_wide_df, here::here("buildings_wide_df.rds"))
# buildings_wide_df <- readRDS(here::here("buildings_wide_df.rds"))

buildings_wide_df_short <-
  buildings_wide_df |>
    # sf::st_drop_geometry() |>
    filter_to_month(start_date) |>
    dplyr::mutate(type = "building")

transit_long_df <- autocruller::ac_get_co2("transit") 
# saveRDS(transit_long_df, here::here("transit_long_df.rds"))
# transit_long_df <- readRDS(here::here("transit_long_df.rds"))

```

```{r}
#| include: false

transit_long_df <- join_transit_osm(transit_long_df)

```

```{r}
transit_long_df_short <- 
transit_long_df |> 
    filter_to_month(start_date) |> 
        dplyr::mutate(type = "transit")
```


```{r}
common_building_types <- buildings_wide_df |> 
  dplyr::group_by(osmtag) |> 
  dplyr::count() |> 
  dplyr::filter(
    n > quantile(n, 0.98, na.rm = TRUE) & osmtag != ""
    )
```

```{r}
#| include: false
# list new countries
new_countries_sentence <- form_new_countries_sentence(buildings_wide_df, buildings_wide_df_short)

```

```{r geocodebuildings}
#| eval: false
#| include: false
buildings_wide_df_short_geo <- geocode_buildings_or_transit(buildings_wide_df_short)

# saveRDS(buildings_wide_df_short_geo, here::here("data/derivative/buildings_wide_df_short_geo.rds"))
```

```{r geocodetransit}
#| eval: false
#| include: false

transit_long_df_short_geo <- geocode_buildings_or_transit(transit_long_df_short)
  
# saveRDS(transit_long_df_short_geo, here::here("data/derivative/transit_long_df_short_geo.rds"))

```


```{r}
#| include: false

buildings_wide_df_short_geo <- 
  # buildings_wide_df_short_geo |> 
  readRDS(here::here("data/derivative/buildings_wide_df_short_geo.rds")) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(
    location_description = glue::glue("{city %||% county %||% province %||% state %||% town %||% municipality %||% region %||% borough %||% suburb %||% neighbourhood %||% city_district}, {country}")
      ) |> 
    sf::st_as_sf(coords = c("X", "Y"), crs = sf::st_crs(buildings_wide_df_short))

buildings_wide_df_short <- sf::st_join(
  buildings_wide_df_short,
  buildings_wide_df_short_geo,
  left = TRUE,
  largest = TRUE
) |> dplyr::ungroup()


buildings_long_df <- autocruller::ac_unnest_longer(buildings_wide_df_short)
```

:::{.cr-section}

## Buildings

```{r mostmeasured}
#| echo: false

most_measured <- 
buildings_wide_df_short |> 
  summarise_most_measured_buildings()
  
```

This month there were `r nrow(buildings_wide_df_short)` measurements of `r length(unique(buildings_wide_df_short$combined_id))` unique buildings. @cr-ccplot 

`r describe_most_measured(most_measured)` 

```{r}
buildings_wide_df_short |> plot_histogram_co2()
```

```{r countriescount}
#| warning: false
#| message: false
countries_count <- 
buildings_wide_df_short |> 
    dplyr::group_by(countryname) |> 
    dplyr::count() |> 
    tidyr::drop_na() |> 
    sf::st_drop_geometry() |> 
    dplyr::ungroup()

# not yet done. need to give transit data a country col
# countries_count_transit <- 
#     transit_long_df |> 
#     dplyr::group_by(countryname) |> 
#     dplyr::summarise(dplyr::n_distinct(uid)) |> 
#     tidyr::drop_na() |> 
#     sf::st_drop_geometry()
# then join with countries_count
countries_count <- countries_count[order(countries_count$n, decreasing = TRUE),] |> 
  tidyr::drop_na() |> 
  dplyr::filter(countryname != "")
# countries_count <- dplyr::left_join(countries_count, countries_count_transit, by = dplyr::join_by(countryname))
# countries_count |> 
#     gt() |> 
#     tab_header(title = "Top countries") |> 
#     cols_label(
#         countryname = "Country",
#         n = "Number of buildings"
#     ) |> 
#     tab_options(
#         table_body.hlines.width = 0
#         )
    
```

:::{#cr-ccplot}

```{r ccplot}
#| warning: false
#| message: false

countries_count |> plot_countries_count()
  
```

:::

There were measurements in `r nrow(countries_count)` seperate countries. `r new_countries_sentence`  

  @cr-buildingtypes 

This graph shows the distribution of the most common building types in the month of `r start_date  |> lubridate::month(label = TRUE, abbr = FALSE)`. The dark bar in the middle of each box and whisker plot shows the median value for each category. The rest of the lines show the range of the distribution. Most of the values fall within each box. If you want more information about how to interpret this graph, watch [this video](https://youtu.be/b2C9I8HuCe4?si=73FKu7wSJr1rWwWt).

As is common, supermarkets tend to have higher CO~2~ values than other types of buildings.

```{r buildingtypes}
#| include: true
#| eval: true
#| warning: false
#| message: false
#| fig.asp: 1.2

plot_building_types(buildings_wide_df)
```

:::{#cr-buildingtypes}

```{r buildingtypes}
#| include: true
#| eval: true
#| warning: false
#| message: false
#| fig.asp: 1.2

plot_building_types_2(buildings_long_df)
```

:::

```{r highlowbuildings}
#| include: false
buildings_long_df_med <- buildings_long_df |> 
  dplyr::filter(
    co2readings >= 400
  ) |> 
    dplyr::group_by(obs_number) |> 
    dplyr::mutate(
      median_co2 = median(co2readings),
      time_n = dplyr::row_number(),
      time_range = range01(time_n),
      description_str = glue::glue("{nwrname} in {location_description}")
    ) |> 
      dplyr::ungroup()

highest_building <- buildings_long_df_med |> 
  dplyr::slice_max(order_by = median_co2)
lowest_building <- buildings_long_df_med |> 
  dplyr::slice_min(order_by = median_co2)
```

```{r highlowsentence}
#| include: false

lowest_sentence <- lowest_building |> 
  dplyr::group_by(obs_number) |> 
  dplyr::summarise(
    description_str = dplyr::first(description_str),
    median_co2 = dplyr::first(median_co2)
  ) |> 
    describe_buildings(measure = "lowest")

highest_sentence <- highest_building |> 
  dplyr::group_by(obs_number) |> 
  dplyr::summarise(
    description_str = dplyr::first(description_str),
    median_co2 = dplyr::first(median_co2)
  ) |> 
    describe_buildings(measure = "highest")

co2_threshold <- 500

buildings_under_threshold <- 
  buildings_long_df_med |> 
  list_buildings_under_threshold(co2_threshold)
```

Here is a graph of all the recordings that happened this month shown by the grey curves. I've highlighted the highest and lowest ones. @cr-allcurves 

`r highest_sentence` `r lowest_sentence` There were some measurements that were even lower than this, but we have removed them from this analysis. Generally outdoor CO~2~ levels don't go below 410 ppm, therefore we have removed any datapoints that are below 400 ppm. If your CO~2~ monitor consistently shows levels below 410 ppm while you are inside or outside, it is likely that your monitor needs recalibrating.

```{r}
#| warning: false
#| eval: false

create_co2_tibble(highest_building) |> 
plot_building_co2_vs_time()
```

```{r}
#| warning: false
#| eval: false

create_co2_tibble(lowest_building) |> 
  plot_building_co2_vs_time()

```

:::{#cr-allcurves}

```{r allcurves3}
#| warning: false
#| message: false
#| fig.asp: 1.4
ylim_max <- max(highest_building$co2readings) + 200
plot_all_curves(buildings_long_df_med, ylim_max)
```

:::
:::

Here is a chart showing the `r nrow(buildings_under_threshold)` measurements that had a median CO~2~ value under `r co2_threshold`. Keep in mind that some of these are potentially miscalibrated sensors or erroneous recordings where the sensor was outside. However, it is important to celebrate the places that do in fact have well ventilated spaces.

```{r thresholdtable}
#| warning: false
#| message: false

# add a column showing how many times a building has been on this list
# buildings_under_threshold |> 
#   knitr::kable(
#     col.names = c("Name", "Median CO<sup>2</sup>", "Building type", "Location")
#   )

gt_buildings_under_threshold(buildings_under_threshold)
```

## Trends over time

The following are charts that are updated every month, but they reflect all data collected so far from the indoorco2 monitoring project (since April 2024). Over time, we should be able to see yearly trends where CO~2~ levels are higher in the Winter when shopkeepers close their windows to keep things warm and then lower CO~2~ levels when shopkeepers open their windows in the Summer.

:::{.cr-section}

@cr-metweekall 

We can start to see trends like in this graph which shows CO~2~ against the week of the year. There are two relevant points you should know about the X axis `Week of the year (meteorological)` before moving on.

1.  Datapoints are aggregated into weeks regardless of the year they are collected in, so some weeks were measured in both 2024 and 2025 but they would both show up in the same week number.

2.  This takes account of the hemisphere in which the recording was collected. Since Winter in the Southern Hemisphere is June through August, while Winter in the Northern Hemisphere is December through February, we have adjusted the week numbers so that they line up meterologically. Essentially, a measurement collected in the Northern Hemisphere on the first of January would show up as week 1, however, a measurement collected in the Southern Hemisphere on the first of January would show up as week 27.

:::{#cr-metweekall}

```{r converthemisphere}
buildings_wide_df <- 
  buildings_wide_df |> 
  add_meteorological_week()
```

```{r}
#| include: false
#| eval: false
plot_buildings_boxplot_date_vs_co2(buildings_wide_df) 
```

```{r metweekall}
#| include: true
#| eval: true
#| warning: false
#| message: false

plot_buildings_week_co2(buildings_wide_df)
```

:::

@cr-metweektype

If we split the graph by the most popular building types, we can start to see some interesting trends. Supermarkets remain relatively high throughout the year with little variation while fast food, and chemists have quite a strong dip in CO~2~ levels during the Summer. This may be because most supermarkets keep their doors closed throughout the year and they tend to have larger buildings; conversely, chemists and fast food restraunts tend to be small to medium sized buildings which means that they can be very easily ventilated if they leave their front door open in the Summer. Restaurants have a very interesting trend here, the strong upward trend of the model at the end of the year is probably due to not enough measurements of restaurants yet rather that there being any meaningful conclusions. Over time we should hopefully see more stable trends show up.

:::{#cr-metweektype}

```{r metweektype}
#| include: true
#| eval: true
#| warning: false
#| message: false

plot_metweek_type(buildings_wide_df)
```

:::

```{r measurethisyear}
#| include: false
measurements_this_year <- 
  buildings_wide_df |> 
  dplyr::filter(dplyr::between(
        date,
        lubridate::today() - lubridate::weeks(52),
        lubridate::today()
    ))|>
       nrow() 
```

Here's a histogram showing how many measurements have been recorded each week since the start of the project. Over the last 12 months there have been `r measurements_this_year` building measurements which is `r round(measurements_this_year/12)` per month or `r round(measurements_this_year/52)` per week. @cr-allhist

:::{#cr-allhist}

```{r allhist}
#| include: true
#| eval: true
#| warning: false
#| message: false
plot_all_histogram(buildings_wide_df)
```

:::
:::

## Transit

```{r transitgeo}
#| eval: true
#| include: false
transit_long_df_short_geo <- 
  # transit_long_df_short_geo |> 
  readRDS(here::here("data/derivative/transit_long_df_short_geo.rds")) |> 
  dplyr::rowwise() |> 
  dplyr::mutate(
    location_description = glue::glue("{city %||% county %||%  state %||% town %||% municipality %||% region %||% borough %||% suburb %||% neighbourhood %||% city_district}, {country}")
      ) |> 
     sf::st_as_sf(coords = c("X", "Y"), crs = sf::st_crs(transit_long_df_short))

transit_long_df_short <- transit_long_df_short |> 
  dplyr::mutate(osm_id_line = as.integer(osm_id_line))

# this doesn't work
# transit_long_df_short <- dplyr::left_join(
#   transit_long_df_short,
#   transit_long_df_short_geo,
#   by = dplyr::join_by(osm_id_line == place_id)
# )

transit_long_df_short <- sf::st_join(
  transit_long_df_short,
  transit_long_df_short_geo,
  left = TRUE,
  largest = TRUE
) |> dplyr::ungroup()
```



```{r mmtransit}
#| echo: false
most_measured_transit <- 
transit_long_df_short |> 
summarise_most_measured_transit()
  
```

:::{.cr-section}

This month there were `r length(unique(transit_long_df_short$uid))` measurements of `r length(unique(transit_long_df_short$line))` unique transit lines. `r describe_most_measured_transit(most_measured_transit)` This graph shows the number of transit recordings in each transit network during the last month. Keep in mind that this graph only shows networks with more than 2 transit recordings this month (there were quite a few with one or two). Transit recordings seem very popular in Vienna and Munich at the moment. @cr-transitcount

:::{#cr-transitcount}

```{r transitcount}
#| warning: false
#| message: false
transit_count <- 
transit_long_df_short |> 
  count_transit()
```

```{r transitcountbar}
#| warning: false
#| message: false
transit_count |> 
  plot_transit_count_bar()
```

:::

When we look at the distribution of CO~2~ measurements by the transit type this month we can see some patterns. Trains often have higher CO~2~ values than buses, subways and trams because they usually travel for longer distances between stations. This causes trains to rely more heavily on mechanical ventilation than buses, subways, and trams which open their doors at stations more frequently. @cr-transitmonthbox

:::{#cr-transitmonthbox}

```{r transitmonthbox}
#| include: true
#| eval: true
#| warning: false
#| message: false
transit_long_df_short |> 
  plot_transit_month_box()
```

:::

This trend can also be seen when we look at the distribution of each transit type on all the data from 2024 and 2025. @cr-transitallbox

:::{#cr-transitallbox}

```{r transitallbox}
#| include: true
#| eval: true
#| warning: false
#| message: false

transit_long_df |> 
  plot_transit_all_box()
```

:::


```{r transitmetweek}
transit_long_df <- 
  transit_long_df |> 
  add_meteorological_week()
```

```{r transitmetplot}
#| include: false
#| eval: false
#| warning: false
#| message: false

transit_long_df |> 
  plot_transit_met_week()
```

:::

That's all for this month! Check back soon for more updates.


### Some thanks

This work would not be possible without the hard work of all the contributors to [OpenStreetMap](https://www.openstreetmap.org/) and [indoorco2map](https://indoorco2map.com). If you would like to contribute to either of these projects, please visit their websites.
You can contribute to the indoorco2map by downloading the [Android app](https://play.google.com/store/apps/details?id=com.aurelwu.indoorairqualitycollector&pcampaignid=pcampaignidMKT-Other-global-all-co-prtnr-py-PartBadge-Mar2515-1) or [iOS app](https://apps.apple.com/us/app/indoorco2map-data-collector/id6504560820?itscg=30200&itsct=apps_box_badge&mttnsubad=6504560820) and connecting it to any one of the following CO~2~ sensors: Aranet4, Airvalent, AirSpot and Inkbird IAM-T1. 
I would also like to thank [Aurel WÃ¼nsch](https://github.com/AurelWu) who tirelessly works on the project as well as the other contributors to the project [ahunt](https://github.com/ahunt), [da5nsy](https://github.com/da5nsy), [paul-hammant](https://github.com/paul-hammant), and [samherniman](https://github.com/samherniman). 

Finally, many thanks go to the teams who work on the following software, which I used heavily. 
```{r}
grateful::cite_packages(output = "paragraph", out.dir = ".")
```

<!-- ## Everything -->

<!-- Combine both long datasets and then make a beeswarm comparing buildings to transit -->

```{r}
#| warning: false
#| message: false
#| eval: false
#| include: false
buildings_long_df |> 
    dplyr::group_by(obs_number) |> 
    dplyr::summarise(
        co2_median = median(co2readings, na.rm = TRUE),
        ventilation = dplyr::first(ventilation)
        ) |> 
tidyplot(
         x = ventilation, 
         y = co2_median,
         color = co2_median
         ) |> 
  # add_violin() |>
  add_data_points_beeswarm(size = 3) |> 
  adjust_y_axis(transform = "log2") |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_x_axis_title("Ventilation system on?") |> 
  adjust_y_axis_title("CO2 ppm average") |> 
  remove_legend() |> 
  # adjust_title("CO2 Averages at music venues") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```

```{r}
#| include: false
#| eval: false

buildings_long_df |> 
    dplyr::group_by(obs_number) |> 
    dplyr::summarise(
        co2_median = median(co2readings, na.rm = TRUE),
        openwindows = dplyr::first(openwindows)
        ) |> 
    sf::st_drop_geometry() |> 
tidyplot(
         x = openwindows, 
         y = co2_median,
         color = co2_median
         ) |> 
  # add_violin() |>
  add_data_points_beeswarm(size = 3) |> 
  adjust_y_axis(transform = "log2") |> 
  adjust_size(width = NA, height = NA, unit = "cm") |> 
  adjust_font(fontsize = 16) |> 
  adjust_x_axis_title("Windows open?") |> 
  adjust_y_axis_title("CO2 ppm average") |> 
  remove_legend() |> 
  # adjust_title("CO2 Averages at music venues") |> 
  adjust_caption("Data from indoorCO2map.com", fontsize = 10)
```